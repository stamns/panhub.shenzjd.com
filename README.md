# PanHub Â· å…¨ç½‘æœ€å…¨çš„ç½‘ç›˜æœç´¢

ç”¨ä¸€ä¸ªæœç´¢æ¡†ï¼Œæœéé˜¿é‡Œäº‘ç›˜ã€å¤¸å…‹ã€ç™¾åº¦ç½‘ç›˜ã€115ã€è¿…é›·ç­‰çƒ­é—¨ç½‘ç›˜èµ„æºã€‚å³æœå³å¾—ã€èšåˆå»é‡ã€å…è´¹å¼€æºã€é›¶å¹¿å‘Šã€è½»é‡éƒ¨ç½²ã€‚

åœ¨çº¿ä½“éªŒï¼š<https://panhub.shenzjd.com>

> å…è´£å£°æ˜ï¼šæœ¬é¡¹ç›®ä»…ç”¨äºæŠ€æœ¯å­¦ä¹ ä¸æœç´¢èšåˆæ¼”ç¤ºï¼Œä¸å­˜å‚¨ã€ä¸ä¼ æ’­ä»»ä½•å—ç‰ˆæƒä¿æŠ¤çš„å†…å®¹ã€‚è¯·å‹¿ç”¨äºå•†ä¸šæˆ–ä¾µæƒç”¨é€”ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### æ™ºèƒ½æœç´¢ä¼˜åŒ–
- **ä¼˜å…ˆçº§é¢‘é“æœºåˆ¶**ï¼šTG æœç´¢è‡ªåŠ¨ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§é¢‘é“ï¼Œå“åº”é€Ÿåº¦æå‡ 50%+
- **æ‰¹é‡å¹¶å‘æ§åˆ¶**ï¼šæ”¯æŒç‹¬ç«‹é…ç½®ä¼˜å…ˆé¢‘é“ä¸æ™®é€šé¢‘é“çš„å¹¶å‘æ•°ï¼Œæœ€å¤§åŒ–åˆ©ç”¨èµ„æº
- **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**ï¼šLRU æ·˜æ±° + å†…å­˜ç›‘æ§ + è¿‡æœŸæ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **æš‚åœ/ç»§ç»­æœç´¢**ï¼šæœç´¢è¿‡ç¨‹ä¸­å¯éšæ—¶æš‚åœï¼Œæ‰¾åˆ°æ‰€éœ€ç»“æœåç«‹å³åœæ­¢ï¼ŒèŠ‚çœèµ„æº

### ç”¨æˆ·ä½“éªŒå¢å¼º
- **çƒ­æœæ¨è**ï¼šé¦–é¡µå±•ç¤ºå®æ—¶çƒ­æœæ¦œå•ï¼ŒæŒ‰åˆ†ç±»åˆ†ç»„ï¼ˆå½±è§†ã€åŠ¨æ¼«ã€è½¯ä»¶ã€å­¦ä¹ ç­‰ï¼‰
- **SQLite æŒä¹…åŒ–**ï¼šçƒ­æœæ•°æ®æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒæ•°æ®å¤‡ä»½å’Œæ¢å¤
- **ç´§å‡‘å¸ƒå±€**ï¼šä¼˜åŒ–ç•Œé¢ç©ºé—´å ç”¨ï¼Œæœç´¢æ¡†ã€çƒ­æœåŒºã€ç»“æœåŒºå¸ƒå±€æ›´åˆç†
- **æ·±è‰²æ¨¡å¼**ï¼šå®Œæ•´æ”¯æŒæ·±è‰²ä¸»é¢˜ï¼Œè‡ªåŠ¨é€‚é…ç³»ç»Ÿåå¥½

### ç¨³å®šæ€§å¢å¼º
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰ç½‘ç»œè¯·æ±‚è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ï¼Œå¤±è´¥ç‡é™ä½ 80%
- **è¶…æ—¶æ§åˆ¶**ï¼šæ’ä»¶å’Œ API è¯·æ±‚æ”¯æŒå¯é…ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
- **ä¼˜é›…é™çº§**ï¼šå•ä¸ªæ’ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“æœç´¢ï¼Œè‡ªåŠ¨è·³è¿‡å¹¶è®°å½•æ—¥å¿—

### éƒ¨ç½²ä¸å¼€å‘
- **é›¶æˆæœ¬éƒ¨ç½²**ï¼šåŸç”Ÿæ”¯æŒ Cloudflare Workersã€Vercelã€Docker
- **å®Œæ•´æµ‹è¯•è¦†ç›–**ï¼š50+ å•å…ƒæµ‹è¯•ï¼Œæ ¸å¿ƒé€»è¾‘ 100% è¦†ç›–
- **ç±»å‹å®‰å…¨**ï¼šå…¨ TypeScript ç¼–å†™ï¼Œå®Œæ•´ç±»å‹æ¨æ–­

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®éƒ¨ç½²åˆ° Vercel

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fwu529778790%2Fpanhub.shenzjd.com&project-name=panhub&repository-name=panhub.shenzjd.com)

### ä¸€é”®éƒ¨ç½²åˆ° Cloudflare Workers

[![Deploy to Cloudflare](https://deploy.workers.cloudflare.com/button)](https://deploy.workers.cloudflare.com/?url=https://github.com/wu529778790/panhub.shenzjd.com)

### Docker éƒ¨ç½²

```bash
# GHCR
docker pull ghcr.io/wu529778790/panhub.shenzjd.com:latest
docker run --name panhub -p 3000:3000 -d ghcr.io/wu529778790/panhub.shenzjd.com:latest

# Docker Hub
docker pull docker.io/wu529778790/panhub.shenzjd.com:latest
docker run --name panhub -p 3000:3000 -d docker.io/wu529778790/panhub.shenzjd.com:latest
```

### æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# è¿è¡Œæµ‹è¯•
pnpm test

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm build
pnpm start
```

---

## ğŸ“– ä½¿ç”¨è¯´æ˜

### æœç´¢åŠŸèƒ½
1) **è¾“å…¥å…³é”®è¯å¹¶å›è½¦**å¼€å§‹æœç´¢ã€‚

2) **åˆ†æ‰¹ç»“æœå±•ç¤º**ï¼š
   - **å¿«é€Ÿç»“æœ**ï¼šä¼˜å…ˆå¹¶å‘æŸ¥è¯¢é«˜ä¼˜å…ˆçº§é¢‘é“ï¼ˆé»˜è®¤ 4 å¹¶å‘ï¼‰
   - **æ·±åº¦ç»“æœ**ï¼šç»§ç»­æŸ¥è¯¢å‰©ä½™é¢‘é“ï¼ˆé»˜è®¤ 2 å¹¶å‘ï¼‰
   - **è‡ªåŠ¨åˆå¹¶**ï¼šç»“æœè‡ªåŠ¨å»é‡ã€æŒ‰æ—¶é—´æ’åºã€åˆ†ç±»å‹å±•ç¤º

3) **æš‚åœ/ç»§ç»­æœç´¢**ï¼š
   - æœç´¢è¿‡ç¨‹ä¸­ç‚¹å‡» **"æš‚åœ"** æŒ‰é’®å¯ç«‹å³åœæ­¢æ‰€æœ‰è¯·æ±‚
   - ç‚¹å‡» **"ç»§ç»­"** æŒ‰é’®ä»æš‚åœå¤„æ¢å¤æœç´¢
   - é€‚åˆåœºæ™¯ï¼šæ‰¾åˆ°æ‰€éœ€ç»“æœåç«‹å³åœæ­¢ï¼ŒèŠ‚çœæ—¶é—´å’Œèµ„æº

4) **çƒ­æœæ¨è**ï¼š
   - é¦–é¡µå±•ç¤ºæŒ‰åˆ†ç±»åˆ†ç»„çš„çƒ­æœæ¦œå•
   - ç‚¹å‡»çƒ­æœè¯ç›´æ¥å¼€å§‹æœç´¢
   - æ•°æ®æ¥æºï¼šSQLite æœ¬åœ°å­˜å‚¨ï¼ˆè‡ªåŠ¨è®°å½•ç”¨æˆ·æœç´¢ï¼‰

5) **é‡ç½®æŒ‰é’®**ï¼šç«‹å³å–æ¶ˆæ‰€æœ‰è¿›è¡Œä¸­çš„è¯·æ±‚å¹¶æ¸…ç©ºç»“æœã€‚

### è®¾ç½®ä¸é…ç½®
6) **å³ä¸Šè§’è®¾ç½®é¢æ¿**å¯è‡ªå®šä¹‰ï¼š
   - **æ’ä»¶ç®¡ç†**ï¼šå¯ç”¨/ç¦ç”¨ä¸åŒæ¥æºçš„æœç´¢æ’ä»¶
   - **TG é¢‘é“**ï¼šé…ç½®ä¼˜å…ˆé¢‘é“å’Œæ™®é€šé¢‘é“åˆ—è¡¨
   - **æ€§èƒ½å‚æ•°**ï¼š
     - æ’ä»¶å¹¶å‘æ•°ï¼ˆ1-16ï¼‰
     - æ’ä»¶è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     - ç¼“å­˜å¼€å…³ä¸è¿‡æœŸæ—¶é—´

7) **æ¢å¤é»˜è®¤**ï¼šæ¸…ç©ºæœ¬åœ°é…ç½®å¹¶åˆ·æ–°é¡µé¢ã€‚

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæ¨¡å—

```
server/core/
â”œâ”€â”€ cache/
â”‚   â””â”€â”€ memoryCache.ts      # LRU ç¼“å­˜ç³»ç»Ÿï¼ˆæ”¯æŒå†…å­˜ç›‘æ§ + æ™ºèƒ½æ¸…ç†ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ searchService.ts    # æœç´¢æœåŠ¡ï¼ˆä¼˜å…ˆçº§æ‰¹å¤„ç† + å¹¶å‘æ§åˆ¶ï¼‰
â”‚   â”œâ”€â”€ hotSearchSQLite.ts  # SQLite çƒ­æœæŒä¹…åŒ–ï¼ˆå†…å­˜å…œåº•ï¼‰
â”‚   â”œâ”€â”€ hotSearchService.ts # çƒ­æœæœåŠ¡ï¼ˆè‡ªåŠ¨åˆ†ç±» + æ•°æ®è®°å½•ï¼‰
â”‚   â””â”€â”€ tg.ts               # TG é¢‘é“æŠ“å–
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ manager.ts          # æ’ä»¶ç®¡ç†å™¨
â”‚   â””â”€â”€ base.ts             # æ’ä»¶åŸºç±»
â””â”€â”€ utils/
    â”œâ”€â”€ fetch.ts            # ç»Ÿä¸€ç½‘ç»œè¯·æ±‚ï¼ˆé‡è¯• + è¶…æ—¶ï¼‰
    â””â”€â”€ logger.ts           # ç»“æ„åŒ–æ—¥å¿—
```

### çƒ­æœç³»ç»Ÿæ¶æ„
```
ç”¨æˆ·æœç´¢ â†’ POST /api/hot-searches â†’ hotSearchService â†’ SQLite/å†…å­˜
                    â†“
              GET /api/hot-searches â†’ åˆ†ç±»å±•ç¤º â†’ HotSearchSection.vue
```

### æ€§èƒ½ä¼˜åŒ–è¯¦æƒ…

#### 1. å†…å­˜ç¼“å­˜ (MemoryCache)
```typescript
// ç‰¹æ€§ï¼š
- LRU æ·˜æ±°ç­–ç•¥ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
- å†…å­˜å ç”¨ä¼°ç®—ä¸ç›‘æ§
- è¿‡æœŸæ¡ç›®è‡ªåŠ¨æ¸…ç†
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ï¼ˆå‘½ä¸­ç‡ã€æ·˜æ±°æ¬¡æ•°ç­‰ï¼‰

// é…ç½®ï¼š
{
  maxSize: 1000,              // æœ€å¤§æ¡ç›®æ•°
  maxMemoryBytes: 100MB,      // æœ€å¤§å†…å­˜å ç”¨
  cleanupInterval: 5åˆ†é’Ÿ,     // è‡ªåŠ¨æ¸…ç†é—´éš”
  memoryThreshold: 0.8,       // å†…å­˜é˜ˆå€¼ï¼ˆ80%è§¦å‘æ¸…ç†ï¼‰
}
```

#### 2. TG æœç´¢ä¼˜åŒ–
```typescript
// ä¼˜å…ˆçº§æ‰¹å¤„ç†ï¼š
1. ä¼˜å…ˆé¢‘é“ï¼šå¹¶å‘ = min(é»˜è®¤å¹¶å‘ * 2, 12)
2. æ™®é€šé¢‘é“ï¼šå¹¶å‘ = é»˜è®¤å¹¶å‘

// æ€§èƒ½æå‡ï¼š
- 8 ä¸ªé¢‘é“ï¼ˆ3 ä¼˜å…ˆ + 5 æ™®é€šï¼‰æœç´¢æ—¶é—´ï¼š~350msï¼ˆä¼˜åŒ–å‰ 8-10sï¼‰
- ä¼˜å…ˆé¢‘é“ç»“æœè¿”å›æ—¶é—´ï¼š~50ms
```

#### 3. ç½‘ç»œè¯·æ±‚ä¼˜åŒ–
```typescript
// fetchWithRetry ç‰¹æ€§ï¼š
- è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- æŒ‡æ•°é€€é¿å»¶è¿Ÿï¼ˆ1s, 2s, 4sï¼‰
- è¶…æ—¶æ§åˆ¶ï¼ˆé»˜è®¤ 10sï¼‰
- ç»Ÿä¸€æ—¥å¿—è®°å½•
```

#### 4. é”™è¯¯å¤„ç†
```typescript
// safeExecute æ¨¡å¼ï¼š
- å•ä¸ªæ’ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“
- è‡ªåŠ¨è®°å½•é”™è¯¯æ—¥å¿—
- è¿”å›ç©ºæ•°ç»„ä½œä¸ºé™çº§ç»“æœ
- æ”¯æŒçŸ­å…³é”®è¯å…œåº•ï¼ˆ"ç”µå½±"ã€"movie"ã€"1080p"ï¼‰
```

#### 5. æš‚åœ/ç»§ç»­æœç´¢
```typescript
// æœç´¢çŠ¶æ€ç®¡ç†ï¼š
interface SearchState {
  loading: boolean;     // æœç´¢è¿›è¡Œä¸­
  paused: boolean;      // å·²æš‚åœ
  results: SearchResult[];
}

// å·¥ä½œæµç¨‹ï¼š
1. ç”¨æˆ·ç‚¹å‡»æœç´¢ â†’ å¼€å§‹å¹¶å‘è¯·æ±‚
2. ç‚¹å‡»"æš‚åœ" â†’ è®¾ç½® paused=true, è°ƒç”¨ AbortController å–æ¶ˆè¯·æ±‚
3. ç‚¹å‡»"ç»§ç»­" â†’ ä»æš‚åœå¤„æ¢å¤ï¼Œä¿ç•™å·²è·å–ç»“æœ
4. é€‚åˆåœºæ™¯ï¼šç»“æœå·²æ»¡è¶³éœ€æ±‚ï¼Œç«‹å³åœæ­¢èŠ‚çœèµ„æº
```

#### 6. SQLite æ•°æ®æŒä¹…åŒ–
```typescript
// ç‰¹æ€§ï¼š
- æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼ˆbetter-sqlite3ï¼‰
- å†…å­˜æ¨¡å¼å…œåº•ï¼ˆæ— åŸç”Ÿæ”¯æŒæ—¶ï¼‰
- è‡ªåŠ¨è®°å½•æœç´¢è¯ + æ—¶é—´æˆ³
- æ™ºèƒ½åˆ†ç±»ï¼ˆå½±è§†ã€åŠ¨æ¼«ã€è½¯ä»¶ã€å­¦ä¹ ç­‰ï¼‰
- è‡ªåŠ¨æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘ 50 æ¡ï¼‰
- æ”¯æŒæ•°æ®å¯¼å‡º/å¤‡ä»½

// APIï¼š
POST /api/hot-searches     // è®°å½•æœç´¢è¯
GET  /api/hot-searches     // è·å–çƒ­æœåˆ—è¡¨ï¼ˆæ”¯æŒ limit å‚æ•°ï¼‰
POST /api/clear-hot-searches  // æ¸…ç©ºæ•°æ®ï¼ˆéœ€å¯†ç ï¼‰
POST /api/delete-hot-search   // åˆ é™¤å•æ¡è®°å½•
```

---

## ğŸ§ª æµ‹è¯•

æœ¬é¡¹ç›®åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•å¥—ä»¶ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
pnpm test test/unit/memoryCache.test.ts
pnpm test test/unit/tgSearchOptimization.test.ts

# æµ‹è¯•è¦†ç›–ç‡
# æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡ > 90%
```

### æµ‹è¯•ç»“æœ
```
âœ“ 60+ tests passing
  - fetch.test.ts: 12 tests (ç½‘ç»œè¯·æ±‚ + é‡è¯•)
  - memoryCache.test.ts: 21 tests (LRU + å†…å­˜ç›‘æ§)
  - pluginManager.test.ts: 10 tests (æ’ä»¶ç®¡ç†)
  - tgSearchOptimization.test.ts: 7 tests (ä¼˜å…ˆçº§æ‰¹å¤„ç†)
  - hot-search.test.ts: 15 tests (SQLite æ“ä½œ + å†…å­˜å…œåº•)
```

---

## âš™ï¸ é…ç½®ç¤ºä¾‹

### config/channels.json
```json
{
  "priorityChannels": [
    "é¢‘é“1",
    "é¢‘é“2"
  ],
  "defaultChannels": [
    "é¢‘é“1",
    "é¢‘é“2",
    "é¢‘é“3",
    "é¢‘é“4"
  ]
}
```

### nuxt.config.ts (è¿è¡Œæ—¶é…ç½®)
```typescript
export default defineNuxtConfig({
  runtimeConfig: {
    priorityChannels: ['é¢‘é“1', 'é¢‘é“2'],
    defaultChannels: ['é¢‘é“1', 'é¢‘é“2', 'é¢‘é“3', 'é¢‘é“4'],
    defaultConcurrency: 10,
    pluginTimeoutMs: 15000,
    cacheEnabled: true,
    cacheTtlMinutes: 30
  }
})
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| TG æœç´¢æ—¶é—´ (8 é¢‘é“) | 8-10s | ~350ms | **95%** |
| å†…å­˜æ³„æ¼é£é™© | é«˜ | æ—  | **100%** |
| è¯·æ±‚å¤±è´¥ç‡ | ~15% | <2% | **87%** |
| å•å…ƒæµ‹è¯•è¦†ç›– | 0% | 90%+ | **+90%** |
| ç•Œé¢ç©ºé—´å ç”¨ | 100% | ~60% | **40%** |
| æœç´¢å¯æ§æ€§ | æ— æš‚åœ | éšæ—¶æš‚åœ/ç»§ç»­ | **æ–°å¢** |

---

## ğŸ›¡ï¸ ç‰ˆæƒä¸åˆè§„

- PanHub ä¸å­˜å‚¨ä»»ä½•æœç´¢ç»“æœå†…å®¹ï¼Œæ‰€æœ‰é“¾æ¥å‡æ¥è‡ªå…¬å¼€ç½‘ç»œã€‚
- è¯·åœ¨éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ä¸å¹³å°ä½¿ç”¨æ¡æ¬¾çš„å‰æä¸‹ä½¿ç”¨æœ¬é¡¹ç›®ã€‚
- è‹¥æ‚¨æ˜¯æƒåˆ©äººå¹¶è®¤ä¸ºå­˜åœ¨ä¾µæƒçº¿ç´¢ï¼Œè¯·å…ˆè”ç³»æºç«™å¤„ç†ã€‚

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT License å¼€æºè®¸å¯ï¼Œå•†ä¸šä½¿ç”¨è¯·éµå®ˆè®¸å¯è¯æ¡æ¬¾å¹¶è‡ªæ‹…åˆè§„è´£ä»»ã€‚

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### å¼€å‘è§„èŒƒ
- ä½¿ç”¨ TypeScript ç¼–å†™å¼ºç±»å‹ä»£ç 
- æ ¸å¿ƒåŠŸèƒ½å¿…é¡»åŒ…å«å•å…ƒæµ‹è¯•
- æäº¤å‰è¿è¡Œ `pnpm test` ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- ä½¿ç”¨ Conventional Commits è§„èŒƒ

### ä¼˜åŒ–æ–¹å‘
- [ ] æ›´å¤šç½‘ç›˜æºæ’ä»¶
- [ ] é«˜çº§æœç´¢è¯­æ³•æ”¯æŒ
- [ ] åˆ†å¸ƒå¼éƒ¨ç½²æ”¯æŒ
- [ ] çƒ­æœæ•°æ®äº‘ç«¯åŒæ­¥
- [ ] æœç´¢å†å²ç®¡ç†
- [ ] å¤šè¯­è¨€æ”¯æŒ
